name: 'Build and Release DEB Package'

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags

permissions: write-all

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y qtbase5-dev qt5-qmake qttools5-dev-tools qtmultimedia5-dev \
        build-essential debhelper devscripts

    - name: Build Project
      run: |
        qmake
        make

    - name: Prepare Debian Package
      run: |
        mkdir -p debian/qstamina/DEBIAN
        mkdir -p debian/qstamina/usr/share/qstamina
        mkdir -p debian/qstamina/usr/share/applications
        mkdir -p debian/qstamina/usr/bin
        mkdir -p debian/qstamina/usr/share/icons
        mkdir -p debian/qstamina/usr/share/icons/hicolor/16x16/apps
        mkdir -p debian/qstamina/usr/share/icons/hicolor/32x32/apps
        mkdir -p debian/qstamina/usr/share/icons/hicolor/48x48/apps
        mkdir -p debian/qstamina/usr/share/icons/hicolor/128x128/apps
        mkdir -p debian/qstamina/usr/share/icons/hicolor/256x256/apps

        # Copy resources
        cp -r src/resources/* debian/qstamina/usr/share/qstamina/

        # Copy binary
        cp QStamina debian/qstamina/usr/bin/qstamina

        # copy deskop entry
        mv debian/qstamina/usr/share/qstamina/qstamina.desktop debian/qstamina/usr/share/applications/qstamina.desktop

        # Create control file
        cat > debian/qstamina/DEBIAN/control << EOF
        Package: qstamina
        Version: ${GITHUB_REF_NAME#v}
        Architecture: amd64
        Maintainer: Zer0C00I
        Depends: libqt5core5a, libqt5gui5, libqt5widgets5, libqtmultimedia5
        Description: Typing tutor software
          QStamina is a typing tutor that helps users improve their typing speed.
        EOF

    - name: Build DEB Package
      run: |
        cd debian/qstamina
        dpkg-deb --build . ../qstamina_${GITHUB_REF_NAME#v}.deb

    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}  
        release_name: Release ${{ github.ref }}  
        draft: false
        prerelease: false

    - name: Upload Release Asset
      id: upload-release-asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./qstamina-${{ github.ref }}-Linux.deb  
        asset_name: qstamina-${{ github.ref }}-Linux.deb  
        asset_content_type: application/vnd.debian.binary-package